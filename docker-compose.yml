networks:
  ls:
    ipam:
      config:
        - subnet: 172.28.0.0/16

services:
  localstack:
    image: localstack/localstack
    ports:
      - 4566:4566
    networks:
      ls:
        ipv4_address: 172.28.0.2
    profiles: ["app:local"]

  dynamodb-admin:
    image: "aaronshaf/dynamodb-admin:latest"
    environment:
      DYNAMO_ENDPOINT: http://localstack:4566
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_REGION: ap-northeast-1
    ports:
      - 8001:8001
    networks:
      - ls
    depends_on:
      - localstack
    profiles: ["app:local"]

  cdk-local:
    image: node:24.1.0-slim
    working_dir: /app/infra
    volumes:
      - ./:/app
      - ${HOME}/.aws/:/root/.aws
    env_file: ./.env
    environment:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: ap-northeast-1
      AWS_REGION: ap-northeast-1
      AWS_ENDPOINT_URL: http://localstack:4566
      AWS_ENDPOINT_URL_S3: http://s3.localhost.localstack.cloud:4566
      AWS_ENVAR_ALLOWLIST: AWS_REGION,AWS_DEFAULT_REGION,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_ENDPOINT_URL,AWS_ENDPOINT_URL_S3
    tty: true
    networks:
      - ls
    dns:
      - 172.28.0.2
    profiles: ["cdk:local"]

  cdk:
    image: node:24.1.0-slim
    working_dir: /app/infra
    volumes:
      - ./:/app
      - ${HOME}/.aws/:/root/.aws
    env_file: ./.env
    tty: true
    profiles: ["cdk"]

  backend:
    image: python:3.13-slim
    working_dir: /app
    volumes:
      - ./backend:/app
      - ${HOME}/.aws/:/root/.aws
    env_file:
      - ./.env
      - ./.env.local
    environment:
      STAGE: local
    ports:
      - "8000:8000"
    command: >
      sh -c "pip install --no-cache-dir -r requirements.txt &&
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload --reload-exclude dist"
    restart: unless-stopped
    profiles: ["app:local"]

  frontend:
    image: node:24.1.0-slim
    working_dir: /app
    volumes:
      - ./frontend:/app
    ports:
      - "5173:5173"
    command: >
      sh -c "npm ci && npm run dev -- --host"
    profiles: ["app:local"]
